<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Journal Viewer</title>
  <style>
    body { margin: 0; overflow: hidden; background: #f0f0f0; }
    canvas { display: block; }
    #status {
      position: fixed;
      top: 8px;
      left: 8px;
      padding: 4px 8px;
      background: rgba(255, 255, 255, 0.9);
      font: 14px sans-serif;
      border: 1px solid #ccc;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="status">Loading…</div>
  <canvas id="cv"></canvas>
  <script>
    const status = document.getElementById('status');
    const canvas = document.getElementById('cv');
    const ctx    = canvas.getContext('2d');
    let data     = null;

    function resize() {
      canvas.width  = window.innerWidth;
      canvas.height = window.innerHeight;
      draw();
    }
    window.addEventListener('resize', resize);

    async function loadJournal() {
      try {
        // ← Fetching your all-caps file name
        const resp = await fetch('JOURNAL.jrn');
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        data = await resp.json();
        console.log('Loaded journal data:', data);
        status.textContent = `Loaded ${data.items?.length || 0} items`;
        resize();
      } catch (err) {
        console.error(err);
        status.textContent = `Error: ${err.message}`;
        // draw the error onto the canvas
        canvas.width  = window.innerWidth;
        canvas.height = window.innerHeight;
        ctx.fillStyle = '#fee';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#900';
        ctx.font = '20px sans-serif';
        ctx.fillText('Failed to load JOURNAL.jrn', 10, 30);
      }
    }

    function draw() {
      if (!data) return;
      // background
      ctx.fillStyle = data.background || '#fff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // debug: if no items, show message
      if (!data.items || data.items.length === 0) {
        ctx.fillStyle = '#333';
        ctx.font = '24px sans-serif';
        ctx.fillText('No journal items to display', 20, 40);
        return;
      }

      // compute scale for a 10 000×10 000 scene
      const scale = Math.min(
        canvas.width  / 10000,
        canvas.height / 10000
      );

      ctx.save();
      ctx.translate(canvas.width/2, canvas.height/2);
      ctx.scale(scale, scale);
      ctx.translate(-5000, -5000);

      for (const itm of data.items) {
        if (itm.type === 'image') {
          const img = new Image();
          img.src = 'data:image/png;base64,' + itm.b64;
          img.onload = () => {
            ctx.drawImage(
              img,
              itm.x, itm.y,
              img.width  * (itm.scale || 1),
              img.height * (itm.scale || 1)
            );
          };
        }
        else if (itm.type === 'text') {
          ctx.fillStyle = '#000';
          ctx.font = '16px Courier New';
          ctx.fillText(itm.text, itm.x, itm.y + 16);
        }
      }

      ctx.restore();
    }

    loadJournal();
  </script>
</body>
</html>
