<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Journal Viewer (Auto‐deconflict)</title>
  <style>
    body {
      margin:0;
      padding:0;
      background:#f0f0f0;
      overflow:auto;
    }
    #viewer {
      position: relative;
      width:10000px;   /* match your scene */
      height:10000px;
      background: #fff;
    }
    .text-item {
      position: absolute;
      font:16px "Courier New", monospace;
      line-height:18px;          /* 16px font + 2px leading */
      white-space: pre-wrap;     /* wrap on spaces, preserve \n */
      word-break: break-word;    /* break super-long words */
      background: rgba(255,255,255,0.8);
    }
    .image-item {
      position: absolute;
      transform-origin: top left;
      pointer-events: none;
      user-select: none;
    }
  </style>
</head>
<body>
  <div id="viewer"></div>
  <script>
  (async function(){
    const resp = await fetch('JOURNAL.jrn');
    if(!resp.ok){ document.body.textContent = 'Error loading'; return; }
    const data = await resp.json();
    const viewer = document.getElementById('viewer');
    viewer.style.background = data.background || '#fff';

    const placed = [];  // will hold {x,y,w,h}

    // helper to test overlap
    function overlaps(a, b){
      return !(a.x + a.w <= b.x ||
               b.x + b.w <= a.x ||
               a.y + a.h <= b.y ||
               b.y + b.h <= a.y);
    }

    // place images
    for(const itm of data.items){
      if(itm.type==='image'){
        const img = document.createElement('img');
        img.className = 'image-item';
        img.src = 'data:image/png;base64,' + itm.b64;
        img.style.left      = itm.x + 'px';
        img.style.top       = itm.y + 'px';
        img.style.transform = `scale(${itm.scale||1})`;
        viewer.appendChild(img);
      }
    }

    // place text, de‐conflicting overlaps
    for(const itm of data.items){
      if(itm.type!=='text') continue;

      const div = document.createElement('div');
      div.className = 'text-item';
      // set width from JSON or default
      if(itm.width){
        div.style.width = itm.width + 'px';
      } else {
        div.style.width = '400px';
      }
      div.style.whiteSpace = 'pre-wrap';
      div.textContent = itm.text;  // preserves \n

      // initial coords
      let x = itm.x, y = itm.y;
      div.style.left = x + 'px';
      div.style.top  = y + 'px';
      div.style.visibility = 'hidden';
      viewer.appendChild(div);

      // measure size
      const rect = div.getBoundingClientRect();
      const parentRect = viewer.getBoundingClientRect();
      const w = rect.width;
      let h = rect.height;

      // now de-conflict: if overlaps any placed, bump down
      let myBox = { x, y, w, h };
      let changed;
      do {
        changed = false;
        for(const other of placed){
          if(overlaps(myBox, other)){
            // push myBox below other by 2px
            myBox.y = other.y + other.h + 2;
            changed = true;
          }
        }
      } while(changed);

      // apply final position
      div.style.top = myBox.y + 'px';
      div.style.visibility = 'visible';

      // record
      placed.push(myBox);
    }
  })();
  </script>
</body>
</html>
