<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Journal Viewer</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #f0f0f0;
      font-family: "Courier New", monospace;
    }
    #status {
      position: fixed;
      top: 8px;
      left: 8px;
      padding: 4px 8px;
      background: rgba(255,255,255,0.9);
      border: 1px solid #ccc;
      font: 14px sans-serif;
      z-index: 1000;
    }
    #container {
      position: absolute;
      top: 0;
      left: 0;
      transform-origin: 0 0;
    }
    #container img {
      position: absolute;
      user-select: none;
      pointer-events: none;
    }
    #container .text-item {
      position: absolute;
      white-space: pre-wrap;       /* preserves your \n */
      font-size: 16px;
      line-height: 1.125;          /* tweak if you need more or less gap */
      color: #000;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="status">Loading…</div>
  <div id="container"></div>
  <script>
    const status = document.getElementById("status");
    const container = document.getElementById("container");

    // pan & zoom state
    let cam = { x: 0, y: 0, scale: 1 };
    let isPanning = false, lastX = 0, lastY = 0;

    // handle pan
    window.addEventListener("mousedown", e => {
      isPanning = true;
      lastX = e.clientX; lastY = e.clientY;
    });
    window.addEventListener("mouseup", () => isPanning = false);
    window.addEventListener("mousemove", e => {
      if (!isPanning) return;
      const dx = e.clientX - lastX, dy = e.clientY - lastY;
      lastX = e.clientX; lastY = e.clientY;
      cam.x += dx;
      cam.y += dy;
      updateTransform();
    });

    // handle zoom
    window.addEventListener("wheel", e => {
      e.preventDefault();
      const rect = container.getBoundingClientRect();
      const ox = e.clientX - rect.left;
      const oy = e.clientY - rect.top;
      const beforeX = (ox - cam.x) / cam.scale;
      const beforeY = (oy - cam.y) / cam.scale;
      const factor = Math.exp(-e.deltaY * 0.001);
      cam.scale *= factor;
      cam.x = ox - beforeX * cam.scale;
      cam.y = oy - beforeY * cam.scale;
      updateTransform();
    }, { passive: false });

    function updateTransform() {
      container.style.transform = 
        `translate(${cam.x}px,${cam.y}px) scale(${cam.scale})`;
    }

    // load and render the journal
    async function load() {
      const resp = await fetch("JOURNAL.jrn");
      if (!resp.ok) {
        status.textContent = "Failed to load JOURNAL.jrn";
        return;
      }
      const data = await resp.json();
      status.textContent = "Rendering…";

      // first, render images
      const images = data.items.filter(i => i.type === "image");
      let done = 0;
      for (let itm of images) {
        const img = new Image();
        img.src = "data:image/png;base64," + itm.b64;
        await new Promise(res => img.onload = res);
        img.style.left   = itm.x + "px";
        img.style.top    = itm.y + "px";
        img.style.width  = img.naturalWidth  * (itm.scale||1) + "px";
        img.style.height = img.naturalHeight * (itm.scale||1) + "px";
        container.appendChild(img);
        done++;
        status.textContent = `Loaded ${done}/${images.length} images…`;
      }

      // next, render text
      for (let itm of data.items.filter(i => i.type === "text")) {
        const div = document.createElement("div");
        div.className = "text-item";
        div.textContent = itm.text;      // preserves your \n
        div.style.left = itm.x + "px";
        div.style.top  = itm.y + "px";
        if (itm.width) {
          div.style.width = itm.width + "px";
        }
        container.appendChild(div);
      }

      status.style.display = "none";
      updateTransform();
    }

    load();
  </script>
</body>
</html>
